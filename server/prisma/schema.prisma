generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id                String    @id @default(uuid())
    firstName         String    @map("first_name")
    lastName          String    @map("last_name")
    username          String?   @unique
    email             String    @unique
    phone             String?   @unique
    password          String
    role              String    @default("CLIENT")
    active            Boolean   @default(true)
    emailVerified     Boolean   @default(false) @map("email_verified")
    passwordChangedAt DateTime? @map("password_changed_at")
    createdAt         DateTime  @default(now()) @map("created_at")
    updatedAt         DateTime  @updatedAt @map("updated_at")

    // Relations
    // User -> AdminPrivilege (One -> Many)
    privileges AdminPrivilege[]
    // User -> Idea (One -> Many)
    ideas      Idea[]

    @@map("users")
}

// ============================================
// Module 1: Idea Intake & Pre-Validation
// ============================================

model Idea {
    id             String   @id @default(uuid())
    userId         String?  @map("user_id")
    rawText        String   @map("raw_text") @db.Text
    refinedText    String?  @map("refined_text") @db.Text
    status         String   @default("draft") // draft | confirmed
    analysisResult Json?    @map("analysis_result")
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")

    // Relations
    // Idea -> User (Many -> One)
    user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
    // Idea -> Document (One -> Many)
    documents Document[]

    @@map("ideas")
}

// ============================================
// Module 2: Document Generation (PRD/BRD)
// ============================================

model Document {
    id        String   @id @default(uuid())
    ideaId    String   @map("idea_id")
    type      String // "PRD" | "BRD"
    title     String
    content   String   @db.Text
    status    String   @default("draft") // draft | published
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    // Document -> Idea (Many -> One)
    idea     Idea              @relation(fields: [ideaId], references: [id], onDelete: Cascade)
    // Document -> DocumentVersion (One -> Many)
    versions DocumentVersion[]

    @@map("documents")
}

model DocumentVersion {
    id         String   @id @default(uuid())
    documentId String   @map("document_id")
    version    Int
    content    String   @db.Text
    changelog  String?  @db.Text
    createdAt  DateTime @default(now()) @map("created_at")

    // Relations
    // DocumentVersion -> Document (Many -> One)
    document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

    @@unique([documentId, version])
    @@map("document_versions")
}

model AdminPrivilege {
    id        String   @id @default(uuid())
    userId    String   @map("user_id")
    name      String
    createdAt DateTime @default(now()) @map("created_at")

    // Relations
    // AdminPrivilege -> User (Many -> One)
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, name])
    @@map("admin_privileges")
}
