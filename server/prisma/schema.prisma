generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id                String    @id @default(uuid())
    firstName         String    @map("first_name")
    lastName          String    @map("last_name")
    username          String?   @unique
    email             String    @unique
    phone             String?   @unique
    password          String
    role              String    @default("CLIENT")
    active            Boolean   @default(true)
    emailVerified     Boolean   @default(false) @map("email_verified")
    passwordChangedAt DateTime? @map("password_changed_at")
    createdAt         DateTime  @default(now()) @map("created_at")
    updatedAt         DateTime  @updatedAt @map("updated_at")

    // Relations
    // User -> AdminPrivilege (One -> Many)
    privileges AdminPrivilege[]
    // User -> Idea (One -> Many)
    ideas      Idea[]

    @@map("users")
}

// ============================================
// Module 1: Idea Intake & Pre-Validation
// ============================================

model Idea {
    id             String   @id @default(uuid())
    userId         String?  @map("user_id")
    rawText        String   @map("raw_text") @db.Text
    refinedText    String?  @map("refined_text") @db.Text
    status         String   @default("draft") // draft | confirmed
    analysisResult Json?    @map("analysis_result")
    createdAt      DateTime @default(now()) @map("created_at")
    updatedAt      DateTime @updatedAt @map("updated_at")

    // Relations
    // Idea -> User (Many -> One)
    user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
    // Idea -> Document (One -> Many)
    documents Document[]
    // Idea -> Diagram (One -> Many)
    diagrams  Diagram[]
    // Idea -> Feature (One -> Many)
    features  Feature[]

    @@map("ideas")
}

// ============================================
// Module 2: Document Generation (PRD/BRD)
// ============================================

model Document {
    id        String   @id @default(uuid())
    ideaId    String   @map("idea_id")
    type      String // "PRD" | "BRD"
    title     String
    content   String   @db.Text
    status    String   @default("draft") // draft | published
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    // Relations
    // Document -> Idea (Many -> One)
    idea     Idea              @relation(fields: [ideaId], references: [id], onDelete: Cascade)
    // Document -> DocumentVersion (One -> Many)
    versions DocumentVersion[]

    @@map("documents")
}

model DocumentVersion {
    id         String   @id @default(uuid())
    documentId String   @map("document_id")
    version    Int
    content    String   @db.Text
    changelog  String?  @db.Text
    createdAt  DateTime @default(now()) @map("created_at")

    // Relations
    // DocumentVersion -> Document (Many -> One)
    document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

    @@unique([documentId, version])
    @@map("document_versions")
}

model AdminPrivilege {
    id        String   @id @default(uuid())
    userId    String   @map("user_id")
    name      String
    createdAt DateTime @default(now()) @map("created_at")

    // Relations
    // AdminPrivilege -> User (Many -> One)
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, name])
    @@map("admin_privileges")
}

// ============================================
// Module 3: Diagram Generation
// ============================================

model Diagram {
    id          String   @id @default(uuid())
    ideaId      String   @map("idea_id")
    type        String // "ERD" | "SEQUENCE" | "SCHEMA" | "FLOWCHART"
    title       String
    mermaidCode String   @map("mermaid_code") @db.Text
    status      String   @default("draft") // draft | published
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @updatedAt @map("updated_at")

    // Relations
    // Diagram -> Idea (Many -> One)
    idea         Idea                 @relation(fields: [ideaId], references: [id], onDelete: Cascade)
    // Diagram -> DiagramVersion (One -> Many)
    versions     DiagramVersion[]
    // Diagram -> FeatureDiagramLink (One -> Many)
    featureLinks FeatureDiagramLink[]

    @@map("diagrams")
}

model DiagramVersion {
    id          String   @id @default(uuid())
    diagramId   String   @map("diagram_id")
    version     Int
    mermaidCode String   @map("mermaid_code") @db.Text
    changelog   String?  @db.Text
    createdAt   DateTime @default(now()) @map("created_at")

    // Relations
    // DiagramVersion -> Diagram (Many -> One)
    diagram Diagram @relation(fields: [diagramId], references: [id], onDelete: Cascade)

    @@unique([diagramId, version])
    @@map("diagram_versions")
}

// ============================================
// Module 4: Feature Breakdown & Task Management
// ============================================

model Feature {
    id          String   @id @default(uuid())
    ideaId      String   @map("idea_id")
    title       String
    description String   @db.Text
    source      String // "auto" | "manual" | "ai_suggested"
    status      String   @default("active") // active | archived
    priority    String   @default("medium") // low | medium | high | critical
    createdAt   DateTime @default(now()) @map("created_at")
    updatedAt   DateTime @updatedAt @map("updated_at")

    // Relations
    // Feature -> Idea (Many -> One)
    idea         Idea                 @relation(fields: [ideaId], references: [id], onDelete: Cascade)
    // Feature -> Task (One -> Many)
    tasks        Task[]
    // Feature -> FeatureVersion (One -> Many)
    versions     FeatureVersion[]
    // Feature -> FeatureDiagramLink (One -> Many)
    diagramLinks FeatureDiagramLink[]

    @@map("features")
}

model FeatureVersion {
    id          String   @id @default(uuid())
    featureId   String   @map("feature_id")
    version     Int
    title       String
    description String   @db.Text
    changelog   String?  @db.Text
    createdAt   DateTime @default(now()) @map("created_at")

    // Relations
    // FeatureVersion -> Feature (Many -> One)
    feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

    @@unique([featureId, version])
    @@map("feature_versions")
}

model Task {
    id              String   @id @default(uuid())
    featureId       String   @map("feature_id")
    title           String
    description     String   @db.Text
    status          String   @default("planned") // planned | in_progress | completed | blocked
    priority        String   @default("medium") // low | medium | high | critical
    estimatedEffort String?  @map("estimated_effort") // e.g., "2h", "1d", "1w"
    order           Int      @default(0)
    createdAt       DateTime @default(now()) @map("created_at")
    updatedAt       DateTime @updatedAt @map("updated_at")

    // Relations
    // Task -> Feature (Many -> One)
    feature      Feature          @relation(fields: [featureId], references: [id], onDelete: Cascade)
    // Task -> TaskVersion (One -> Many)
    versions     TaskVersion[]
    // Task -> TaskDependency (One -> Many) - dependencies on this task
    dependents   TaskDependency[] @relation("DependentTask")
    // Task -> TaskDependency (One -> Many) - this task depends on others
    dependencies TaskDependency[] @relation("DependsOnTask")

    @@map("tasks")
}

model TaskVersion {
    id          String   @id @default(uuid())
    taskId      String   @map("task_id")
    version     Int
    title       String
    description String   @db.Text
    status      String
    changelog   String?  @db.Text
    createdAt   DateTime @default(now()) @map("created_at")

    // Relations
    // TaskVersion -> Task (Many -> One)
    task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

    @@unique([taskId, version])
    @@map("task_versions")
}

model TaskDependency {
    id              String   @id @default(uuid())
    taskId          String   @map("task_id")
    dependsOnTaskId String   @map("depends_on_task_id")
    createdAt       DateTime @default(now()) @map("created_at")

    // Relations
    // TaskDependency -> Task (Many -> One) - the dependent task
    task      Task @relation("DependentTask", fields: [taskId], references: [id], onDelete: Cascade)
    // TaskDependency -> Task (Many -> One) - the task it depends on
    dependsOn Task @relation("DependsOnTask", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)

    @@unique([taskId, dependsOnTaskId])
    @@map("task_dependencies")
}

model FeatureDiagramLink {
    id        String   @id @default(uuid())
    featureId String   @map("feature_id")
    diagramId String   @map("diagram_id")
    createdAt DateTime @default(now()) @map("created_at")

    // Relations
    // FeatureDiagramLink -> Feature (Many -> One)
    feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)
    // FeatureDiagramLink -> Diagram (Many -> One)
    diagram Diagram @relation(fields: [diagramId], references: [id], onDelete: Cascade)

    @@unique([featureId, diagramId])
    @@map("feature_diagram_links")
}
